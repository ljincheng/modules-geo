(function(){MapGIS.Layers.extend({TileLayer:new Class({Extends:MapGIS.Layers.BaseLayer,Implements:[Events,Options],options:{initialExtent:null,startShowLevel:0,level:0,tileSize:256,url:null},initLayer:function(){this.zoomObj.div=this.div},posLast:[0,0,0,0,0,0],Point0:{cell:0,row:0,left:0,top:0},isFullDraw:true,dragingLayer:function(a){if(this.parent(a)){this.drawTile(a)}else{this.div.empty()}},reloadLayer:function(a){this.reloadTile()},getTileNo:function(b,d){var h=this.options.tileSize;var g=this.mapoptions.options.origin;var f=d[0];var e=d[1];var j=Math.floor((f-g.x)/b.x/h);var i=Math.floor((g.y-e)/b.y/h);var a=-(f-g.x)/b.x+h*j;var c=-(g.y-e)/b.y+h*i;return{cell:j,row:i,left:a,top:c}},getTagName:function(b){var a=this.options.id+"_";return a+"z_"+b},drawTile:function(h){if(!h.isMoving()){return}var f=h.getTiles();if(!h.hasNewTile(this.id)){return}var p=this.options.id+"_";var m=h.getLevel();var n=this.options.url;var b=this.getTagName(m);var o=h.getTileSize();var l=f.newtiles;for(var e=0,c=l.length;e<c;e++){var j=l[e];var a=p+j.id;this.loadImage(n,m,j.c,j.r,j.l,j.t,o,b,a,false)}var g=f.deltiles;this.zoomObj.clear();for(var e=0,c=g.length;e<c;e++){var j=g[e];var d=this.div.getElementById(p+j.id);if(d){d.destroy()}}},redrawTile:function(h){var f=h.getTiles();var p=this.options.id+"_";var m=h.getLevel();var n=this.options.url;var b=this.getTagName(m);var o=h.getTileSize();var l=f.alltiles;for(var e=0,c=l.length;e<c;e++){var j=l[e];var a=p+j.id;this.loadImage(n,m,j.c,j.r,j.l,j.t,o,b,a,false)}var g=f.deltiles;this.zoomObj.clear();for(var e=0,c=g.length;e<c;e++){var j=g[e];var d=this.div.getElementById(p+j.id);if(d){d.destroy()}}},zoomLayer:function(e){if(this.parent(e)){this.zoomImgsToLayer(e);var a=e.getPreLevel();var d=e.getLevel();var c=this.getTagName(a);this.zoomObj.clclass=this.getTagName(d);if(this.loadZoomImgsHandle!=null){window.clearTimeout(this.loadZoomImgsHandle)}if(this.clearImgsHandle!=null){window.clearInterval(this.clearImgsHandle)}this.loadZoomImgsHandle=window.setTimeout(function(){this.reloadTile();this.clearImgsHandle=window.setInterval(this.loadedImgsEvent.bind(this),10,this.getTagName(d))}.bind(this),200);if(c!=this.zoomObj.imgclass){var b=this.div.getElements("img."+c);if(b.length>0){b.each(function(f){f.destroy()})}}}else{this.div.empty()}},clearImgsHandle:null,loadZoomImgsHandle:null,loadImage:function(h,g,j,l,c,i,k,m,b,f){var e={z:g,y:j,x:l};var a=h.substitute(e);var d=this.div.getElementById(b);if(d){d.src=a}else{d=new Element("img",{unselectable:"on",src:a,id:b,"class":m,loaded:"false",styles:{position:"absolute",left:c,top:i,width:k,height:k,border:"0px",margin:"0px",padding:"0px","z-index":2}});d.setStyle("-webkit-user-select","none");d.setStyle("-moz-user-select","none");d.inject(this.div);d.onselectstart=function(){return false};d.onload=function(){this.set("loaded","true")}}},loadedImgsEvent:function(d){var e=this.div.getElements("img."+d);var c=true;if(e.length>0){for(var b=0,a=e.length;b<a;b++){if(e[b].get("loaded")!="true"){c=false;break}}}if(c){this.zoomObj.clear();window.clearInterval(this.clearImgsHandle)}return c},zoomObj:{imgclass:null,clclass:null,res:null,imgSize:null,div:null,clear:function(){if(this.clclass!=this.imgclass){var a=this.div.getElements("img."+this.imgclass);if(a.length>0){a.each(function(b){b.destroy()})}this.imgclass=null;this.res=null;this.imgSize=null}}},effects:[],zoomImgsToLayer:function(h){if(this.effects!=null&&this.effects.length>0){var g=this.effects;for(var f=0,e=g.length;f<e;f++){g[f].cancel()}this.effects=[]}var j=h.getPreLevel();if(this.zoomObj.imgclass==null){var d=this.getTagName(j);this.zoomObj.imgclass=d}if(this.zoomObj.res==null){this.zoomObj.res=h.resolution(j)}if(this.zoomObj.imgSize==null){this.zoomObj.imgSize=h.getTileSize()}var m=this.div.getElements("img."+this.zoomObj.imgclass);var l=h.getPos();var n=h.getWheelPos();var q=[-l[0]+n[0],-l[1]+n[1]];var c=h.getRes();var b=this.zoomObj.res;var o=this.zoomObj.imgSize;var a=b.x/c.x;var p=o*b.x/c.x;if(m!=null&&m.length>0){m.each(function(r){var x=r.getStyle("left").toInt();var v=r.getStyle("top").toInt();var k=r.getStyle("width").toInt();var u=r.getStyle("height").toInt();var i=(q[0]-(q[0]-x)*a);var s=(q[1]-(q[1]-v)*a);r.setStyles({left:i,top:s,width:p,height:p,"z-index":1})}.bind(this))}else{}this.zoomObj.imgSize=p;this.zoomObj.res=c},reloadTile:function(){var e=this.mapoptions;var m=this.options.id+"_";var g=e.getLevel();var j=e.getTiles().alltiles;var b=this.getTagName(g);var l=e.getTileSize();var h=this.options.url;var g=e.getLevel();for(var d=0,c=j.length;d<c;d++){var f=j[d];var a=m+f.id;this.loadImage(h,g,f.c,f.r,f.l,f.t,l,b,a,true)}},refresh:function(){var d=this.parent();if(d){var b=this.options.url;var a=new Date().getTime();var c=b.match(/\?[^\?]*/);if(c!=null){if(c!="?"){if(b.match(/(DT=T)\d{13}(T)/g)!=null){b=b.replace(/(DT=T)\d{13}(T)/g,"DT=T"+a+"T")}else{b=b+"&DT=T"+a+"T"}}else{b=b+"DT=T"+a+"T"}}else{b=b+"?DT=T"+a+"T"}this.options.url=b;this.reloadTile()}}})})})();