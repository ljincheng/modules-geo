(function(){MapGIS.Layers.extend({MarkerLayer:new Class({Extends:MapGIS.Layers.BaseLayer,Implements:[Events,Options],options:{isLigature:false,rebuildPoint:true,combosWindow:true,paletteObj:null,mapLayer:null,tabWindow:null,imgDeflectX:10,imgDeflectY:34,imgWidth:20,imgHeight:34,imgClass:"marker",strokecolor:"#0c68c5",strokeweight:2,imgSrc:"",visibleWindow:false,defaultMarker:null,pointClickFn:null,simpleDisplay:false,effects:false,selectedPointID:null,graphicsData:[]},geometry:null,lineRoot:null,graphicsRoot:null,geomDIV:null,pointList:[],showLines:false,pointObjLayer:null,selectedItem:{index:-1,marker:null},loadZoomImgsHandle:null,loadLayer:function(b){var a=b.getViewSize();this.options.width=a[0];this.options.height=a[1];this.div.setStyle("-webkit-user-select","");this.div.setStyle("-moz-user-select","");this.div.onselectstart=function(){return true};this.div.unselectable="";this.pointObjLayer=new Element("div",{styles:{position:"absolute",left:0,top:0,zIndex:2}});this.div.appendChild(this.pointObjLayer);this.geomDIV=new Element("div",{styles:{display:"none",pointerEvents:"none",position:"absolute",left:0,top:0,zIndex:1}});this.geomDIV.inject(this.div);this.geometry=new MapGIS.Geometry(this.geomDIV,{width:this.options.width,height:this.options.height});this.lineRoot=this.geometry.creatGroup();this.graphicsRoot=this.geometry.creatGroup();this.loader=true;this.parent(b)},hexUnescape:function(a){if(typeof a!="undefined"&&(a!=null)){a=a.replace(/\\[u,U]/g,"%u");return unescape(a)}else{return""}},dragingLayer:function(d){if(this.parent(d)){if(this.options.simpleDisplay){this.geomDIV.setStyle("display","none")}var b=d.isMoving();if(!b){this.drawGeom();this.drawLine();var c=this.mapoptions.getPos();var a={left:-c[0],top:-c[1]};this.geomDIV.setStyles(a)}}},reloadLayer:function(c){this.drawGeom();this.drawLine();var b=this.mapoptions.getPos();var a={left:-b[0],top:-b[1]};this.geomDIV.setStyles(a)},zoomLayer:function(c){if(this.parent(c)){this.transformPointCoord();this.drawGeom();this.drawLine();var b=this.mapoptions.getPos();var a={left:-b[0],top:-b[1]};this.geomDIV.setStyles(a)}},eventFn_click:function(h,f,o){h.stopPropagation();if(this.options.visibleWindow){var c=this.getCardWindowID(o);if($(c)){$(c).fade("in");$(c).setStyle("z-index",++this.cardIndex);this.setCardData(o,f)}else{var g=this.cardWindow(o,f);if(g!=null){g.inject(this.pointObjLayer)}}}var c=this.id+"_p_"+(o);var i={srcElement:$(c),row:o,data:f,layer:this};this.fireEvent("click",i);this.fireEvent("pointclick",i);if(this.options.effects&&this.options.selectedPointID!=null){if(this.options.selectedPointID!=c){var m=$(this.options.selectedPointID);var j=m.getStyle("background-position");var b=m.getStyle("width");var d=j.split(" ");var a=d[0];var n=d[1];var k=a.toInt();var l=b.toInt();m.setStyle("background-position",(k+l)+"px "+n);m.removeClass("focusMapPoint")}}this.options.selectedPointID=c},eventFn_mouseOver:function(d,c,f){d.stopPropagation();var g=this.id+"_p_"+(f);var a=$(g);var b={srcElement:a,row:f,data:c,layer:this};this.fireEvent("pointmouseover",b);this.fireEvent("mouseover",b);a.addClass("focusMapPoint");this.effectsStart(f)},eventFn_mouseOut:function(d,c,f){d.stopPropagation();var g=this.id+"_p_"+(f);var a=$(g);var b={srcElement:a,row:f,data:c,layer:this};this.fireEvent("pointmouseout",b);this.fireEvent("mouseout",b);a.removeClass("focusMapPoint");this.effectsEnd(f)},effectsStart:function(i){if(this.options.effects){var b=this.id+"_p_"+(i);var h=$(b);if(this.options.selectedPointID!=b){var e=h.getStyle("background-position");var c=h.getStyle("width");var d=e.split(" ");var a=d[0];var j=d[1];var f=a.toInt();var g=c.toInt();h.setStyle("background-position",(f-g)+"px "+j)}}},effectsEnd:function(i){if(this.options.effects){var b=this.id+"_p_"+(i);var h=$(b);if(this.options.selectedPointID!=b){var e=h.getStyle("background-position");var c=h.getStyle("width");var d=e.split(" ");var a=d[0];var j=d[1];var f=a.toInt();var g=c.toInt();h.setStyle("background-position",(f+g)+"px "+j)}else{h.addClass("focusMapPoint")}}},getElementByID:function(a){return this.pointObjLayer.getElementById(this.id+"_p_"+a)},toScreen:function(c){var b=this.mapoptions.toLayerScreen(c[0],c[1]);var a={x:(b[0]),y:(b[1])};return a},setData:function(a){this.selectedItem.index=-1;this.options.selectedPointID=null;this.pointList=a;this.drawPoint();this.drawLine()},setGraphicsData:function(a){this.options.graphicsData=a;if(this.loader&&this.isContinue()){this.drawGeom()}},getLatLngValue:function(d){if(d!=null){var a=d.x||d.X||d.xpos;var e=d.y||d.Y||d.ypos;var b=typeof(a)=="string"?a.toFloat():a;var c=typeof(e)=="string"?e.toFloat():e;return[b,c]}else{return null}},setDefaultMarker:function(a){this.options.defaultMarker=a},setMarkerImage:function(b){this.options.imgSrc=this.options.source+"images/transparent.gif";this.options.imgDeflectY=34;this.options.imgDeflectX=10;this.options.imgWidth=20;this.options.imgHeight=34;this.options.imgClass="marker";if(b!=null){for(var a in b){this.options[a]=b[a]}}},selectedPoint:function(r,l){this.selectedItem.index=r;if(l){this.selectedItem.marker=l}var n=this.pointList;if(n!=null&&n.length>0){var g=this.id+"_p_";this.cardIndex++;var a=this.cardIndex;var o=(this.selectedItem.marker!=null?true:false);var d=null;if(o){this.setMarkerImage(this.selectedItem.marker);d=this.options.imgClass}for(var j=0,h=n.length;j<h;j++){var c=g+j;if($(c)){var e=$(c);var l=n[j].marker;if(o){e.removeClass(d)}if(l){this.setMarkerImage(l)}else{this.setMarkerImage(this.options.defaultMarker)}e.removeClass(this.options.imgClass);if(this.selectedItem.index==j){this.setMarkerImage(this.selectedItem.marker);e.setStyle("zIndex",a)}var q=this.getLatLngValue(n[j]);var b=null;if(q!=null){b=this.toScreen(q)}else{break}var f=parseInt(b.x)-this.options.imgDeflectX;var m=parseInt(b.y)-this.options.imgDeflectY;e.setStyles({left:f,top:m});if(!e.hasClass(this.options.imgClass)){e.addClass(this.options.imgClass)}}}}},drawPoint:function(){var q=this.pointList;this.pointObjLayer.empty();if(q!=null){var c=this.id;for(var g=0,e=q.length;g<e;g++){var r=this.getLatLngValue(q[g]);var b=null;if(r!=null){b=this.toScreen(r)}else{continue}var h=q[g].marker;if(h){this.setMarkerImage(h)}else{this.setMarkerImage(this.options.defaultMarker)}if(this.selectedItem.index==g){this.setMarkerImage(this.selectedItem.marker)}var d=parseInt(b.x)-this.options.imgDeflectX;var o=parseInt(b.y)-this.options.imgDeflectY;var j=this.hexUnescape(q[g].html);var l=this.hexUnescape(q[g].title);var n=q[g].show;var a=c+"_p_"+g;var f=new Element("div",{id:a,unselectable:"on","class":"pointImages",styles:{left:d,top:o,position:"absolute",cursor:"pointer",display:"block",fontSize:"12px"},events:{click:this.eventFn_click.bindWithEvent(this,[q[g],g]),mouseover:this.eventFn_mouseOver.bindWithEvent(this,[q[g],g]),mouseout:this.eventFn_mouseOut.bindWithEvent(this,[q[g],g])}});f.addClass(this.options.imgClass);f.addClass(c+"_pointimg");if(j!=null){f.set("html",j)}if(l!=null){f.set("title",l)}f.inject(this.pointObjLayer);if(this.options.visibleWindow){if(n){var m=this.cardWindow(g,q[g]);if(m!=null){m.inject(this.pointObjLayer)}}}}}},drawLine:function(){this.clearLines();if(this.showLines){var f=this.pointList;if(f!=null){var g=this.id;var c=[];for(var b=0,a=f.length;b<a;b++){var e=this.getLatLngValue(f[b]);var d=null;if(e!=null){d=this.mapoptions.toScreen(e[0],e[1]);c.push(d)}else{continue}}this.lineFN(c)}}},dpos:[0,0],ds:[0,0],isRun:false,runIndex:1,mytimeout:null,lineFN:function(a){if(this.mytimeout!=null){window.clearInterval(this.mytimeout)}this.isRun=true;this.runIndex=1;if(a!=null&&a.length>0){this.dpos=a[0]}this.mytimeout=window.setInterval(this.gotoLine.bind(this,[a]),120)},gotoLine:function(c){if(!this.isRun){window.clearInterval(this.mytimeout)}else{if(c!=null&&c.length>this.runIndex){var l=[];for(var d=0,b=this.runIndex;d<b;d++){l.push(c[d])}var h=c[this.runIndex];var g=this.runIndex-1;var e=c[g];this.ds=[(h[0]-e[0])/4,(h[1]-e[1])/4];this.dpos=[this.dpos[0]+this.ds[0],this.dpos[1]+this.ds[1]];var s=Math.abs(this.dpos[0]-e[0]);var r=Math.abs(this.dpos[1]-e[1]);var p=Math.abs(h[0]-e[0]);var o=Math.abs(h[1]-e[1]);var m=[e];if(s>=p||r>=o){this.runIndex++;l.push(h)}else{m.push(this.dpos)}this.clearLines();var j={stroke:{color:"#4A2C48",width:3}};this.geomDIV.setStyle("display","block");if(l.length>1){var a=this.geometry.nodeFactory("shape");this.geometry.drawLineString(a,l,false,j);a.inject(this.lineRoot)}if(m.length>1){var n={stroke:{color:"#BB261F",width:3}};var q=this.geometry.nodeFactory("shape");this.geometry.drawLineString(q,m,false,n);q.inject(this.lineRoot)}}else{this.isRun=false}}},drawGeom:function(){var a=this.options.graphicsData;this.clearGraphics();if(a!=null&&a.length>0){this.geomDIV.setStyle("display","block");var d=[];for(var h=0,f=a.length;h<f;h++){var l=a[h].data;var g=null;var n=a[h].gtype;var m=a[h].gstyle;if(n=="CIRCLE"){var p=this.mapoptions.toScreen(l.x,l.y);var b=l.r/this.mapoptions.resolution(this.mapoptions.getLevel()).x;g={x:parseInt(p[0]),y:parseInt(p[1]),r:b}}else{g=[];for(var e=0,j=l.length;e<j;e++){var o=l[e];var p=this.mapoptions.toScreen(o[0],o[1]);g.push(p)}}var c=null;switch(n){case"RECTANGLE":c=this.geometry.nodeFactory("shape");this.geometry.drawRectangle(c,g,m);break;case"CIRCLE":c=this.geometry.nodeFactory("circle");this.geometry.drawCircle(c,g,m,true);break;case"LINE":c=this.geometry.nodeFactory("shape");this.geometry.drawLineString(c,g,false,m);break;case"LINEARRING":c=this.geometry.nodeFactory("shape");this.geometry.drawLineString(c,g,true,m);break;default:c=this.geometry.nodeFactory("shape");this.geometry.drawPolygon(c,g,m);break}c.inject(this.graphicsRoot)}}},clearPoint:function(){this.pointObjLayer.empty()},clearLines:function(){var b=this.lineRoot.children;if(b&&b.length>0){var a=((b&&b.length>0)?b.length:0);while(b&&b.length>0&&a>0){if(b[0].ignore){b[0].ignore("click",null);b[0].ignore("mouseover",null);b[0].ignore("mouseout",null);b[0].ignore("mouseup",null);b[0].ignore("mousedown",null);b[0].ignore("dblclick",null)}if(b[0].data){b[0].data=null}if(b[0].resetResolution){b[0].resetResolution=null}if(b[0]._geotype){b[0]._geotype=null}if(b[0]._style){b[0]._style=null}if(b[0]._options){b[0]._options=null}b[0].eject();a--}}},clearGraphics:function(){var b=this.graphicsRoot.children;if(b&&b.length>0){var a=((b&&b.length>0)?b.length:0);while(b&&b.length>0&&a>0){if(b[0].ignore){b[0].ignore("click",null);b[0].ignore("mouseover",null);b[0].ignore("mouseout",null);b[0].ignore("mouseup",null);b[0].ignore("mousedown",null);b[0].ignore("dblclick",null)}if(b[0].data){b[0].data=null}if(b[0].resetResolution){b[0].resetResolution=null}if(b[0]._geotype){b[0]._geotype=null}if(b[0]._style){b[0]._style=null}if(b[0]._options){b[0]._options=null}b[0].eject();a--}}},clear:function(){this.pointList=null;this.pointList=[];this.options.graphicsData=null;this.options.graphicsData=[];this.clearPoint();this.clearGraphics();this.clearLines()},destory:function(){this.clear();this.removeEvents("pointclick");this.removeEvents("pointmouseover");this.removeEvents("click");this.removeEvents("mouseover");this.removeEvents("dblclick")},transformPointCoord:function(){var r=this.pointList;if(r!=null){var f=this.id+"_p_";for(var j=0,g=r.length;j<g;j++){var b=f+j;if($(b)){var d=$(b);var s=this.getLatLngValue(r[j]);var c=null;if(s!=null){c=this.toScreen(s)}else{break}var n=r[j].content;var h=r[j].marker;if(h){this.setMarkerImage(h)}else{this.setMarkerImage(this.options.defaultMarker)}d.removeClass(this.options.imgClass);if(this.selectedItem.index==j){this.setMarkerImage(this.selectedItem.marker)}var e=parseInt(c.x)-this.options.imgDeflectX;var q=parseInt(c.y)-this.options.imgDeflectY;var l=r[j].html;var m=r[j].title;var o=r[j].show;d.setStyles({left:e,top:q});if(!d.hasClass(this.options.imgClass)){d.addClass(this.options.imgClass)}}}var a=this.pointObjLayer.getElements("div.pointImages_card");a.each(function(i){var u=i.retrieve("pdata");var t=this.getLatLngValue(u);var k=null;if(t==null){return}else{k=this.toScreen(t)}i.setStyles({left:k.x,top:k.y})}.bind(this))}},cardIndex:1,getCardWindowID:function(b){if(this.options.combosWindow){var a=this.id;return a+"_tbl"}else{var a=this.id;return a+"_p_"+b+"_tbl"}},combosWindowData:null,setCardData:function(e,b){var a=this.getCardWindowID(e);if($(a+"_con")){$(a+"_con").set("html",this.hexUnescape(b.content));if($(a)){var d=this.getLatLngValue(b);var c=null;if(d==null){return}else{c=this.toScreen(d)}$(a).store("pdata",b);$(a).setStyles({left:c.x,top:c.y})}}if(this.options.combosWindow){this.combosWindowData=b}},cardWindow:function(b,e){this.cardIndex++;var f=this.hexUnescape(e.content);var k=this.getCardWindowID(b);var j=this.getLatLngValue(e);var c=null;if(j==null){return}else{c=this.toScreen(j)}var d=c.x;var i=c.y;if($(k)){$(this.getCardWindowID(b)).store("pdata",e);$(this.getCardWindowID(b)).setStyles({left:d,top:i});return null}var g=this.source+"images/window/";var a='<div style="z-index:1;position:absolute; bottom:68px; left:-38px; min-width:200px;box-shadow: #666 0px 0px 10px; -moz-box-shadow: #666 0px 0px 10px;-webkit-box-shadow: #666 0px 0px 10px; background:#ffffff; border:1px solid #ababab;">';a+="<br>";a+='<img src="'+g+'IMCloseButton_Normal.png"   onclick=\'MapGIS.closeTabWindow("'+k+'",event)\'  style="position:absolute;top:5px; cursor:pointer; right:5px;"/>';a+='<div id="'+k+'_con" style="min-width:240px;min-height:100px; margin:10px;" onclick="MapGIS.stopPropagation(event)">';a+=(typeof(f)=="undefined"?"":f);a+="</div>";a+='<div style="width:200px;height:1px; "></div><div style="position:absolute; bottom:-70px; BACKGROUND: url('+g+'w.png) no-repeat -5px -715px; width:92px; height:70px; margin-top:-64px; margin-left:38px;"></div>';a+="</div>";var h=new Element("div",{id:k,"class":"pointImages_card",styles:{left:(d)+"px",top:i+"px",position:"absolute",cursor:"pointer",display:"block",fontSize:"12px",border:"0px solid black","z-index":this.cardIndex}});h.set("html",a);h.store("pdata",e);h.addEvent("mousedown",function(l){l.stopPropagation();return true});h.addEvent("mouseup",function(l){l.stopPropagation();return true});h.addEvent("mousemove",function(l){l.stopPropagation();return true});return h}})})})();